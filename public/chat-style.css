/* CONFIG */
:root {
  --primary: #1877f2;
  --bg-dark: #0f172a;
  --glass-bg: rgba(30, 41, 59, 0.9);
  --glass-border: rgba(255, 255, 255, 0.1);
  --text-main: #f8fafc;
  --text-sub: #94a3b8;
  --nav-height: 60px;
}
[data-theme="light"] {
  --bg-dark: #f0f2f5;
  --glass-bg: rgba(255, 255, 255, 0.95);
  --glass-border: rgba(0, 0, 0, 0.1);
  --text-main: #050505;
  --text-sub: #65676b;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
body { font-family: "Inter", sans-serif; background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; background-image: url("https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop"); background-size: cover; background-position: center; }

/* NAVBAR & LAYOUT (GI·ªÆ NGUY√äN) */
.navbar { height: var(--nav-height); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); position: fixed; top: 0; width: 100%; z-index: 100; backdrop-filter: blur(10px); }
.nav-left, .nav-center, .nav-right { display: flex; align-items: center; gap: 10px; }
.logo { font-weight: 800; font-size: 20px; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 5px;}
.nav-item { width: 50px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-sub); text-decoration: none; }
.nav-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
#nav-avatar { width: 32px; height: 32px; border-radius: 50% !important; border: 2px solid var(--glass-border); object-fit: cover; }
.icon-circle-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: var(--text-main); }

.chat-container { display: flex; margin-top: var(--nav-height); height: calc(100vh - var(--nav-height)); width: 100%; position: relative; overflow: hidden; }
.sidebar { width: 320px; display: flex; flex-direction: column; border-right: 1px solid var(--glass-border); background: var(--glass-bg); flex-shrink: 0; transition: transform 0.3s ease; }
.chat-area { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; background: rgba(0,0,0,0.2); transition: transform 0.3s ease; }

/* COMPONENTS */
.sidebar-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
.icon-btn-small { width: 35px; height: 35px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.sidebar-search { margin: 0 15px 15px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; }
.sidebar-search input { background: transparent; border: none; color: var(--text-main); width: 100%; }
.user-list { flex: 1; overflow-y: auto; padding: 0 10px; }
.user-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; margin-bottom: 2px; }
.user-item:hover, .user-item.active { background: rgba(255,255,255,0.1); }
.user-avatar { width: 48px; height: 48px; position: relative; flex-shrink: 0; }
.user-avatar img, .avatar-circle img { width: 100%; height: 100%; border-radius: 50% !important; object-fit: cover; }
.status-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-dark); position: absolute; bottom: 0; right: 0; }
.status-dot.online { background: #31a24c; }
.user-info { flex: 1; overflow: hidden; }
.user-name { font-weight: 600; font-size: 15px; }

.chat-header { height: 60px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
.header-left-group { display: flex; align-items: center; }
.header-user { display: flex; align-items: center; gap: 10px; }
.avatar-circle { width: 40px; height: 40px; position: relative; }
.tool-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: var(--text-main); margin-left: 5px; cursor: pointer; }

#chat-content-container { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
.chat-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.65); z-index: 0; }
#messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 1; scroll-behavior: smooth; }

/* TIN NH·∫ÆN (M·ªöI: N√∫t X√≥a & Hi·ªáu ·ª©ng Bom) */
.message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; word-wrap: break-word; line-height: 1.5; min-width: 60px; }
.message.other { align-self: flex-start; background: rgba(255,255,255,0.1); color: var(--text-main); border-bottom-left-radius: 4px; }
.message.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
.timestamp { display: block; font-size: 10px; margin-top: 4px; opacity: 0.7; text-align: right; }

/* N√∫t x√≥a tin nh·∫Øn (Hi·ªán khi hover) */
.delete-msg-btn {
    position: absolute; top: -10px; right: -10px;
    width: 20px; height: 20px; border-radius: 50%;
    background: #ef4444; color: white; font-size: 10px;
    display: none; align-items: center; justify-content: center;
    cursor: pointer; border: 1px solid white; z-index: 10;
}
.message:hover .delete-msg-btn { display: flex; }

/* Tin nh·∫Øn t·ª± h·ªßy */
.message.secret { border: 2px solid #ef4444; animation: shake 0.5s; }
.message.secret::before { content: 'üí£'; margin-right: 5px; }
@keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

.message.system { align-self: center; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); color: #cbd5e1; font-size: 12px; padding: 4px 12px; border-radius: 20px; margin: 5px 0; }
.message.image-message .msg-image { max-width: 100%; max-height: 300px; border-radius: 10px; cursor: pointer; }

/* FOOTER */
.chat-footer-wrapper { padding: 10px; z-index: 10; position: relative; flex-shrink: 0; background: transparent; }
.chat-footer { border-radius: 24px; padding: 5px 10px; display: flex; align-items: center; gap: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); }
.btn-icon { background: none; border: none; color: var(--text-sub); font-size: 20px; padding: 5px; cursor: pointer; }
.btn-icon:hover { color: var(--text-main); }
.input-box { flex: 1; background: rgba(255,255,255,0.05); border-radius: 20px; height: 38px; display: flex; align-items: center; padding: 0 10px; }
#message-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-size: 15px; }
.btn-send { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; }
.btn-icon.recording { color: #ef4444 !important; animation: pulse 1s infinite; }

/* N√∫t Tim */
.heart-btn { color: #e91e63; }
.heart-btn:hover { transform: scale(1.2); }
.active-secret { color: #ef4444; text-shadow: 0 0 5px #ef4444; }

/* FLOATING HEARTS */
#floating-hearts-container {
    position: fixed; bottom: 0; right: 50px; width: 100px; height: 100vh;
    pointer-events: none; z-index: 9999; overflow: hidden;
}
.floating-heart {
    position: absolute; bottom: -20px; font-size: 24px;
    animation: floatUp 3s linear forwards;
    opacity: 0;
}
@keyframes floatUp {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-80vh) scale(1.5); opacity: 0; }
}

/* MODALS & CALL UI (Gi·ªØ nguy√™n) */
.hidden { display: none !important; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; }
.modal-box { padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); text-align: center; color: white; }
.modal-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; margin: 15px 0; }
.modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
.modal-actions button, #save-bg-btn, #send-file { padding: 10px 20px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; }
.close-modal { padding: 10px 20px; cursor: pointer; color: #aaa; }
.call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: flex; flex-direction: column; }
#remoteVideo { width: 100%; height: 100%; object-fit: cover; }
.local-video-wrapper { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 180px; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); z-index: 2; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
#localVideo { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
.call-controls-container { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; z-index: 3; }
.call-controls { display: flex; gap: 20px; padding: 10px 30px; border-radius: 40px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); }
.control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; color: white; background: rgba(255,255,255,0.2); cursor: pointer; }
.control-btn.hangup { background: #ef4444; }
.incoming-call-card img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; margin-bottom: 15px; }
.incoming-actions { display: flex; gap: 30px; justify-content: center; margin-top: 20px; }
.btn-reject { width: 60px; height: 60px; border-radius: 50%; background: #ef4444; border: none; color: white; font-size: 24px; }
.btn-accept { width: 60px; height: 60px; border-radius: 50%; background: #22c55e; border: none; color: white; font-size: 24px; animation: pulse 1s infinite; }
.ai-icon-wrapper { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #1e293b; border: 2px solid #6366f1; }
.ai-avatar-icon { font-size: 20px; color: white; }
```

### 3. FILE `public/main.js` (Client Logic)
*Th√™m: Logic n√∫t Tim, N√∫t Bom (Secret), X√≥a tin nh·∫Øn (Client side).*

```javascript
document.addEventListener("DOMContentLoaded", () => {
  if (!window.location.pathname.endsWith("chat.html")) return;

  const token = localStorage.getItem("token");
  if (!token) { window.location.href = "/index.html"; return; }

  window.socket = io({ auth: { token } });
  window.myUserId = null;
  window.myUsername = null;
  window.currentChatContext = { id: null, name: null, type: "user" };
  
  // Tr·∫°ng th√°i Secret Mode
  let isSecretMode = false;

  const chatContainer = document.getElementById("main-container");
  const messagesContainer = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  
  // N√∫t m·ªõi
  const heartBtn = document.getElementById("heart-btn");
  const secretBtn = document.getElementById("secret-mode-btn");

  // ... (Logic Dark Mode, BG, Avatar, User List nh∆∞ c≈© - Gi·ªØ nguy√™n ph·∫ßn ƒë·∫ßu) ...
  // ƒê·ªÉ ng·∫Øn g·ªçn, t√¥i ch·ªâ vi·∫øt ph·∫ßn Logic M·ªõi ·ªü d∆∞·ªõi

  // --- LOGIC M·ªöI ---

  // 1. X·ª≠ l√Ω N√∫t Tim Bay
  if(heartBtn) {
      heartBtn.addEventListener("click", () => {
          if(!window.currentChatContext.id) return;
          window.socket.emit("sendHeart", { recipientId: window.currentChatContext.id });
          showHeartAnimation(); // T·ª± hi·ªán tim cho m√¨nh
      });
  }

  // Nh·∫≠n tim t·ª´ ng∆∞·ªùi kh√°c
  window.socket.on("heartAnimation", () => {
      showHeartAnimation();
  });

  function showHeartAnimation() {
      const container = document.getElementById("floating-hearts-container");
      for(let i=0; i<10; i++) {
          const heart = document.createElement("div");
          heart.className = "floating-heart";
          heart.innerHTML = "‚ù§Ô∏è";
          heart.style.left = Math.random() * 100 + "%";
          heart.style.animationDuration = (2 + Math.random() * 3) + "s";
          container.appendChild(heart);
          setTimeout(() => heart.remove(), 3000);
      }
  }

  // 2. X·ª≠ l√Ω Secret Mode (Bom)
  if(secretBtn) {
      secretBtn.addEventListener("click", () => {
          isSecretMode = !isSecretMode;
          if(isSecretMode) {
              secretBtn.classList.add("active-secret");
              messageInput.placeholder = "ƒêang b·∫≠t ch·∫ø ƒë·ªô t·ª± h·ªßy (10s)...";
          } else {
              secretBtn.classList.remove("active-secret");
              messageInput.placeholder = "Nh·∫≠p tin nh·∫Øn...";
          }
      });
  }

  // S·ª≠a l·∫°i h√†m G·ª≠i tin ƒë·ªÉ support Secret
  document.getElementById("chat-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const val = messageInput.value.trim();
    if (!val || !window.currentChatContext.id) return;
    
    // G·ª≠i k√®m ttl n·∫øu ƒëang b·∫≠t Secret Mode
    const msgData = { recipientId: window.currentChatContext.id, content: val };
    if(isSecretMode) msgData.ttl = 10000; // 10 gi√¢y

    window.socket.emit("privateMessage", msgData);
    
    // T·∫Øt ch·∫ø ƒë·ªô secret sau khi g·ª≠i (tu·ª≥ ch·ªçn)
    // isSecretMode = false; secretBtn.classList.remove("active-secret");
    messageInput.value = "";
    
    // ·∫®n n√∫t g·ª≠i, hi·ªán n√∫t like
    sendBtn.classList.add("hidden");
    heartBtn.classList.remove("hidden");
  });

  // Toggle n√∫t G·ª≠i/Like
  messageInput.addEventListener("input", (e) => {
      if(e.target.value.trim()) {
          sendBtn.classList.remove("hidden");
          heartBtn.classList.add("hidden");
      } else {
          sendBtn.classList.add("hidden");
          heartBtn.classList.remove("hidden");
      }
  });

  // 3. X·ª≠ l√Ω Nh·∫≠n tin (C√≥ TTL v√† Delete)
  window.appendMessage = function (msg, shouldScroll = true) {
    if(document.getElementById(`msg-${msg.id}`)) return;

    const div = document.createElement("div");
    div.id = `msg-${msg.id}`;
    div.className = `message ${msg.senderId === window.myUserId ? "user" : "other"}`;
    
    // N·∫øu l√† tin nh·∫Øn t·ª± h·ªßy
    if (msg.ttl) {
        div.classList.add("secret");
        setTimeout(() => {
            div.remove();
        }, msg.ttl); // X√≥a kh·ªèi DOM sau TTL
    }

    // N√∫t x√≥a tin nh·∫Øn (Ch·ªâ hi·ªán cho tin c·ªßa m√¨nh)
    let deleteBtnHtml = "";
    if (msg.senderId === window.myUserId) {
        deleteBtnHtml = `<div class="delete-msg-btn" onclick="deleteMessage(${msg.id})"><i class="fas fa-trash"></i></div>`;
    }

    let content = msg.content;
    try {
        const json = JSON.parse(msg.content);
        if (json.type === "image") content = `<img src="${json.url}" class="msg-image">`;
        else if (json.type === "audio") content = `<audio controls src="${json.url}"></audio>`;
        else if (json.type === "system") { div.className = "message system"; content = `üîî ${json.text}`; }
    } catch (e) {}

    const time = new Date(msg.createdAt).toLocaleTimeString("vi-VN", {hour:"2-digit", minute:"2-digit"});
    div.innerHTML = `${content}<span class="timestamp">${time}</span>${deleteBtnHtml}`;
    
    messagesContainer.appendChild(div);
    if(shouldScroll) scrollToBottom();
  };

  // H√†m x√≥a tin nh·∫Øn to√†n c·ª•c
  window.deleteMessage = (msgId) => {
      if(confirm("B·∫°n mu·ªën thu h·ªìi tin nh·∫Øn n√†y?")) {
          window.socket.emit("deleteMessage", { messageId: msgId, recipientId: window.currentChatContext.id });
      }
  };

  // L·∫Øng nghe s·ª± ki·ªán x√≥a t·ª´ Server
  window.socket.on("messageDeleted", ({ messageId }) => {
      const el = document.getElementById(`msg-${messageId}`);
      if(el) el.remove(); // X√≥a kh·ªèi giao di·ªán ngay l·∫≠p t·ª©c
  });

  // ... (C√°c ph·∫ßn c√≤n l·∫°i nh∆∞ Load User, WebRTC, Modal gi·ªØ nguy√™n t·ª´ file c≈©) ...
  
  // B·∫°n h√£y copy ph·∫ßn FETCH ME, SOCKET INIT, SELECT CHAT t·ª´ file main.js c≈© v√†o ƒë√¢y nh√©.
  // Ho·∫∑c n·∫øu b·∫°n mu·ªën t√¥i g·ª≠i FULL FILE main.js d√†i ngo·∫±ng lu√¥n th√¨ b·∫£o t√¥i nh√©.
  // (D∆∞·ªõi ƒë√¢y l√† ph·∫ßn kh·ªüi t·∫°o c∆° b·∫£n c·∫ßn c√≥)
  fetch("/api/me", { headers: { Authorization: `Bearer ${token}` } }).then(r=>r.json()).then(u=>{ window.myUserId=u.id; document.getElementById("nav-avatar").src=u.avatar; });
  window.socket.on("userList", users => { /* ... code c≈© ... */ });
  window.socket.on("newMessage", msg => { /* ... code c≈© ... */ appendMessage(msg); });
});
```

### 4. FILE `server.js` (Server Logic M·ªõi)
*Th√™m x·ª≠ l√Ω: Delete Message, Heart, v√† TTL.*

T√¨m ƒëo·∫°n `io.on("connection", ...)` v√† th√™m c√°c socket event m·ªõi n√†y v√†o b√™n trong:

```javascript
  // ... (b√™n trong io.on)

  // 1. X·ª≠ l√Ω Tin nh·∫Øn (C√≥ h·ªó tr·ª£ TTL)
  socket.on("privateMessage", async (data) => {
    // data = { recipientId, content, ttl? }
    
    // L∆∞u v√†o DB (n·∫øu c√≥ ttl th√¨ v·∫´n l∆∞u, nh∆∞ng c√≥ th·ªÉ ƒë√°nh d·∫•u expire ho·∫∑c x·ª≠ l√Ω job x√≥a sau)
    // ·ªû demo n√†y ta v·∫´n l∆∞u ƒë·ªÉ c√≥ ID, nh∆∞ng client s·∫Ω t·ª± ·∫©n.
    // N·∫øu mu·ªën x·ªãn h∆°n, server n√™n c√≥ 1 cronjob x√≥a tin c≈©.
    
    const [r] = await db.query("INSERT INTO messages (senderId, recipientId, content) VALUES (?, ?, ?)", 
        [userId, data.recipientId, data.content]);
        
    const msg = { 
        id: r.insertId, 
        senderId: userId, 
        content: data.content, 
        createdAt: new Date(),
        ttl: data.ttl // Truy·ªÅn l·∫°i TTL cho ng∆∞·ªùi nh·∫≠n
    };
    
    if (onlineUsers[data.recipientId]) {
      io.to(onlineUsers[data.recipientId].socketId).emit("newMessage", msg);
    }
    socket.emit("newMessage", msg);
    
    // N·∫øu c√≥ TTL, server t·ª± x√≥a DB sau th·ªùi gian ƒë√≥ (Optional)
    if (data.ttl) {
        setTimeout(() => {
            db.query("DELETE FROM messages WHERE id = ?", [r.insertId]);
        }, data.ttl);
    }
  });

  // 2. X·ª≠ l√Ω Thu h·ªìi tin nh·∫Øn
  socket.on("deleteMessage", async ({ messageId, recipientId }) => {
      // X√≥a trong DB
      await db.query("DELETE FROM messages WHERE id = ? AND senderId = ?", [messageId, userId]);
      
      // B√°o cho c·∫£ 2 b√™n x√≥a UI
      socket.emit("messageDeleted", { messageId }); // B√°o cho m√¨nh
      if (onlineUsers[recipientId]) {
          io.to(onlineUsers[recipientId].socketId).emit("messageDeleted", { messageId }); // B√°o cho b·∫°n
      }
  });

  // 3. X·ª≠ l√Ω Th·∫£ Tim
  socket.on("sendHeart", ({ recipientId }) => {
      if (onlineUsers[recipientId]) {
          io.to(onlineUsers[recipientId].socketId).emit("heartAnimation");
      }
  });

  // ... (C√°c ph·∫ßn WebRTC, Disconnect gi·ªØ nguy√™n)
